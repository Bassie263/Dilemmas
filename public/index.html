<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="reset.css">
    <link rel="stylesheet" href="style.css">
    <title>Document</title>
</head>
<body>
    <div class="join">
        <h1>submit your <br><span>dilemma's</span></h1>
        <div class="scan">
            <canvas id="qr" class="qr"></canvas>
            <p><a href="#" id="remoteUrl">Join!</a></p>
        </div>
    
        <div class="status">
            <p class="devices" id="devices">No participants (yet)</p>
            <p class="submitted" id="submitted">No dilemma's submitted yet</p>
        </div>
    </div>
    <div class="dilemma">
        <p class="vote-counts">0</p>
    </div>


    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js" integrity="sha512-pUhApVQtLbnpLtJn6DuzDD5o2xtmLJnJ7oBoMsBnzOkVkpqofGLGPaBJ6ayD2zQe3lCgCibhJBi4cj5wAxwVKA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <script>
    {

        let socket;
        let remoteUrl = document.getElementById('remoteUrl');


        const init = () => {
                        
            socket = io();

            socket.on('socket-id', (id) => {
            const urlParams = new URLSearchParams(window.location.search);
            urlParams.set('socketId', id);
            history.replaceState({}, '', `${window.location.pathname}?${urlParams.toString()}`);
            });
            
            

            socket.on('connect', () => {
                const ip = window.location.hostname;

                const url = `${new URL(`/remote.html?id=${socket.id}`, window.location)}`;

                remoteUrl.href = url;

                var qr = new QRious({
                element: document.getElementById('qr'),
                value: url,
                size: 400,
                background: 'transparent',
                foreground: '#E50809',
                level: 'L',
                });

                socket.emit('get-client-count');
                socket.on('client-count', (count) => {
                    if (count === 2) {
                        document.getElementById('devices').innerText = `${count-1} participant registered`;
                    } else {
                        document.getElementById('devices').innerText = `${count-1} participants registered`;
                    }

                    //max 10 participants
                    if (count === 11) {
                        document.getElementById('devices').innerText = `Max 10 participants reached`;
                    }

                });


                socket.on('options-updated', (options) => {
                    console.log('Options:');
                    options.forEach(([option1, option2]) => {
                    console.log(`  - Option 1: ${option1}`);
                    console.log(`  - Option 2: ${option2}`);
                    });                    
                    const length = options.length;
                    if (length === 1) {
                            document.getElementById('submitted').innerText = `1 dilemma submitted`;
                        } else {
                            document.getElementById('submitted').innerText = `${length} dilemma's submitted`;
                        }
                });

                const $dilemma = document.querySelector('.dilemma');
                const $join = document.querySelector('.join');
                const $body = document.querySelector('body');

                socket.on('start-dilemma', (options) => {
                    console.log('Start button pressed, lets play!');
                    $join.style.display = 'none';
                    $dilemma.style.display = 'block';
                    $body.style.backgroundImage = 'linear-gradient(90deg, rgba(241,136,150,1) 0%, rgba(229,8,9,1) 100%)';


                    //display a random dilemma
                    const random = Math.floor(Math.random() * options.length);
                    const dilemma = options[random];
                    $dilemma.innerHTML = `
                    <div class='options'>
                        <p class='option1'> ${dilemma[0]}</p>
                        <p class='option2' >${dilemma[1]}</p>
                    </div>
                    `;
                    


                });



            }); 


    
    }; 

        init();

    }

    </script>
</body>
</html>