<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="reset.css">
    <link rel="stylesheet" href="style.css">
    <title>Document</title>
</head>
<body>
    <div class="join">
        <h1>submit your <br><span>dilemma's</span></h1>
        <div class="scan">
            <canvas id="qr" class="qr"></canvas>
            <p><a href="#" id="remoteUrl">Join!</a></p>
        </div>
    
        <div class="status">
            <p class="devices" id="devices">No participants (yet)</p>
            <p class="submitted" id="submitted">No dilemma's submitted yet</p>
        </div>
    </div>
    <div class="dilemma">
        
    </div>

    <div class="votes">
        <div class="count1"></div>
        <div class="count2"></div>
    </div>


    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js" integrity="sha512-pUhApVQtLbnpLtJn6DuzDD5o2xtmLJnJ7oBoMsBnzOkVkpqofGLGPaBJ6ayD2zQe3lCgCibhJBi4cj5wAxwVKA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <script>
    {

        let socket;
        let remoteUrl = document.getElementById('remoteUrl');


        const init = () => {
                        
            socket = io();

            socket.on('socket-id', (id) => {
            const urlParams = new URLSearchParams(window.location.search);
            urlParams.set('socketId', id);
            history.replaceState({}, '', `${window.location.pathname}?${urlParams.toString()}`);
            });
            
            

            socket.on('connect', () => {
                const ip = window.location.hostname;
            }); 

            const url = `${new URL(`/remote.html?id=${socket.id}`, window.location)}`;

            const $count1 = document.querySelector('.count1');
            const $count2 = document.querySelector('.count2');
            const $votes = document.querySelector('.votes');
            const $next_btn = document.getElementById('next_btn');


            remoteUrl.href = url;

            var qr = new QRious({
            element: document.getElementById('qr'),
            value: url,
            size: 200,
            background: 'transparent',
            foreground: '#E50809',
            level: 'L',
            });

            socket.emit('get-client-count');
            socket.on('client-count', (count) => {
                if (count === 2) {
                    document.getElementById('devices').innerText = `${count-1} participant registered`;
                } else {
                    document.getElementById('devices').innerText = `${count-1} participants registered`;
                }

                //max 10 participants
                if (count === 11) {
                    document.getElementById('devices').innerText = `Max 10 participants reached`;
                }

            });


            socket.on('options-updated', (options) => {
                console.log('Options:');
                options.forEach(([option1, option2]) => {
                console.log(`  - Option 1: ${option1}`);
                console.log(`  - Option 2: ${option2}`);
                });                    
                const length = options.length;
                if (length === 1) {
                        document.getElementById('submitted').innerText = `1 dilemma submitted`;
                    } else {
                        document.getElementById('submitted').innerText = `${length} dilemma's submitted`;
                    }
            });

            const $dilemma = document.querySelector('.dilemma');
            const $join = document.querySelector('.join');
            const $body = document.querySelector('body');

            socket.on('start-dilemma', (options) => {
                console.log('Start button pressed, lets play!');
                $join.style.display = 'none';
                $dilemma.style.display = 'block';
                $body.style.backgroundImage = 'linear-gradient(90deg, rgba(241,136,150,1) 0%, rgba(229,8,9,1) 100%)';
                
                //display the dilemma

                const dilemma = options[options.length - 1];
                $dilemma.innerHTML = `
                <div class='options'>
                    <p class='option1'> ${dilemma[0]}</p>
                    <p>or</p>
                    <p class='option2' >${dilemma[1]}</p>
                </div>
                `;
                


            });

            function toRomanNumerals(num) {
            if (isNaN(num)) {
                return 'Invalid input';
            }

            const numerals = {
                M: 1000,
                CM: 900,
                D: 500,
                CD: 400,
                C: 100,
                XC: 90,
                L: 50,
                XL: 40,
                X: 10,
                IX: 9,
                V: 5,
                IV: 4,
                I: 1,
            };

            let roman = '';
            let remaining = num;

            // Iterate through numerals in descending order
            for (const key in numerals) {
                const value = numerals[key];
                while (remaining >= value) {
                roman += key;
                remaining -= value;
                }
            }

            return roman;
            }

            socket.on('vote-count', (data) => {
                // Convert counts to Roman numerals
                const romanCount1 = toRomanNumerals(data.count1);
                const romanCount2 = toRomanNumerals(data.count2);

                // Update the HTML with Roman numerals
                $count1.innerHTML = `<p> ${romanCount1}</p>`;
                $count2.innerHTML = `<p> ${romanCount2}</p>`;
            });

            

            socket.on ('winner', (winner) =>{
                //display a tie
                if (winner === 'It is a tie') {
                    $dilemma.innerHTML = `
                    <div class='options'>
                        <p>It's a tie!</p>
                    </div>`;
                    $votes.style.display = 'none';

                } else {
                    $dilemma.innerHTML = `
                    <div class='options'>
                        <p>voted winner: <br>${winner}</p>
                    </div>`;
                    $votes.style.display = 'none';
                }
            });

            socket.on('no-dilemmas', () => {
                    console.log('No dilemmas anymore');
                    $dilemma.innerHTML = `<p>play again!</p>`;

                    setTimeout(() => {
                        location.reload();
                    }, 5000);
                });


    
    }; 

        init();

    }

    </script>
</body>
</html>