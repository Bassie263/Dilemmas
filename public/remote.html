<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="reset.css">
    <link rel="stylesheet" href="style.css">
    <title>Document</title>

</head>
<body>
    <form id="form">
        <div class="dilemma">
            <input type="text" id="option1" placeholder="option1">
            <p>or</p>
            <input type="text" id="option2" placeholder="option2">
            <div class="buttons">
                <button class="button" id="submit" type="submit">submit dilemma</button>
                <button class="button" id="start">Start</button>
            </div>
        </div>        
    </form>
    <div class="options-remote"> </div>


    <p class="waiting"> waiting for opponents<br><span>...</span></p>



    <script src="/socket.io/socket.io.js"></script>
    <script>
    {
        let socket;
        const dilemma = document.querySelector('.dilemma');


        const init = () => {
            socket = io();

            socket.on('connect', () => {
                console.log(`Connected: ${socket.id}`);

                //send the socket id to the server
                socket.emit('get-socket-id');

                //get the IP address of the server
                const ip = window.location.hostname;

                const url = `${window.location}/remote.html?targetSocketId=${socket.id}`;
            });

            socket.emit('get-client-count');
                socket.on('client-count', (count) => {

                //add the values of the options in an array
                const options = [];
                const submit = document.getElementById('submit');
                const start = document.getElementById('start');
                const option1 = document.getElementById('option1');
                const option2 = document.getElementById('option2');
                const form = document.getElementById('form');
                const waiting = document.querySelector('.waiting');

                submit.addEventListener('click', (e) => {
                    e.preventDefault();
                    const option1Value = option1.value;
                    const option2Value = option2.value;

                    // Controleer of beide waarden ingevuld zijn
                    if (option1Value && option2Value) {
                        form.reset();

                        console.log(option1Value, option2Value);

                        // Verzend de waarden naar de server
                        socket.emit('submit-dilemma', { option1: option1Value, option2: option2Value });
                    } else {
                        return;
                }
                });

                start.addEventListener('click', (e) => {
                    e.preventDefault();
                    form.style.display = 'none';
                    waiting.style.display = 'block';
                    //zend een bericht naar de server, die zegt dat de start knop is ingedrukt
                    socket.emit('start-dilemma');
                });


                socket.on('options-updated', (options) => {
                    console.log('Options:', options);  

                });

                const $body = document.querySelector('body');
                const $options = document.querySelector('.options-remote');

                window.addEventListener('devicemotion', (event) => {
                    const { acceleration } = event;
                    const xAccel = acceleration.x;

                    if (xAccel > 0) {
                        // Vote for option 2
                        socket.emit('choice-made', dilemma[1]);
                    } else if (xAccel < 0) {
                        // Vote for option 1
                        socket.emit('choice-made', dilemma[0]);
                    }
                });

                socket.on('start-dilemma', (options) => {
                    console.log('Start button pressed, lets play!');
                    waiting.style.display = 'none';



                    //display a random dilemma
                    const dilemma = options[options.length - 1];
                    $options.style.display = 'flex';
                    $options.innerHTML = 
                    `<p class='option1'> ${dilemma[0]}</p>
                    <div class='vertical-line'></div>
                    <p class='option2' >${dilemma[1]}</p>`;

                    const $choice1 = document.querySelector('.option1');
                    const $choice2 = document.querySelector('.option2');
                    const $verticalLine = document.querySelector('.vertical-line');
                    
                    $choice1.addEventListener('click', () => {
                        socket.emit('choice-made', dilemma[0]);
                        $options.style.justifyContent = 'center';
                        $choice1.style.alignItems = 'center';
                        $choice1.style.width = '100%';
                        $choice1.innerHTML = `You chose <br> ${dilemma[0]}`;
                        $choice2.style.display = 'none';
                        $verticalLine.style.display = 'none';


                    });

                    $choice2.addEventListener('click', () => {
                        socket.emit('choice-made', dilemma[1]);
                        $options.style.justifyContent = 'center';
                        $choice2.style.alignItems = 'center';
                        $choice2.style.width = '100%';
                        $choice2.innerHTML = `You chose <br> ${dilemma[1]}`;
                        $choice1.style.display = 'none';
                        $verticalLine.style.display = 'none';

                    });

                });

                socket.on('winner', (winner) => {
                    console.log('The winner is:', winner);

                    //display a tie
                    if (winner === 'It is a tie') {
                        $options.innerHTML = `<p>It's a tie!<p>`;
                    } else {
                        $options.innerHTML = `<p>Voted winner:<br>${winner}</p>`;
                    }

                });

                //restart the game
                socket.on('no-dilemmas', () => {
                    $options.innerHTML = `<p>No dilemmas anymore</p>`;
                    socket.off('restart');
                    setTimeout(() => {
                        location.reload();
                    }, 5000);
                });


                socket.on('restart', (dilemma) => {
                    socket.emit('start-dilemma');
                });


            
            
        
        });


        }; 

        init();
    }
    </script>
</body>
</html>
